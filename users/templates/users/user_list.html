{% extends 'base_generic.html' %}
{% block content %}
{% load static %}
{% if request.GET.view == 'table' %}
		<div class="container-fluid mt-4">
			<h2 class="text-center mb-4">–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
			<div class="mb-3 text-end">
				<a href="{% url 'mass_mail' %}" class="btn btn-warning">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º</a>
			</div>
			<div class="card p-4" style="border-radius: 12px;">
				{% include 'users/_user_table.html' %}
			</div>
		</div>
{% else %}
<style>
	.grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
		gap: 20px;
	}
	.card {
		background-color: #A5D6A7;
		border-radius: 10px;
		padding: 20px;
		box-shadow: 0 4px 8px rgba(0,0,0,0.1);
		transition: transform 0.2s ease;
	}
	.card:hover { transform: scale(1.02); }
	.username { font-size: 1.2em; font-weight: bold; color: #1B5E20; }
	.email { font-size: 0.95em; color: #2E7D32; margin-bottom: 10px; }
	.yellow-text { color: #FFD600 !important; font-weight: bold; }
	.actions { display: flex; gap: 10px; margin-top: 10px; }
	.actions a { flex: 1; background-color: #4CAF50; color: white; border: none; padding: 8px; border-radius: 6px; text-decoration: none; transition: background-color 0.2s ease; }
	.actions a:hover { background-color: #388E3C; }
	@media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
</style>
<!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ (–ø–ª–∏—Ç–∫–∏) -->
<form id="user-list-form" method="post" action="">
	{% csrf_token %}
	<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 8px;">
		<label style="color: #fff;"><input type="checkbox" id="select-all"> <b>–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö</b></label>
		<div style="display: flex; gap: 8px; align-items: center; margin-bottom: 0;">
			<select name="locality_id" class="form-select form-select-sm" style="width: 180px;">
				<option value="">‚Äî –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –Ω–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç ‚Äî</option>
				{% for loc in localities %}
					<option value="{{ loc.id }}">{{ loc.name }}</option>
				{% endfor %}
			</select>
			<button type="submit" class="btn btn-success btn-sm">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
		</div>
	</div>
	{% if request.GET.locality_id %}
	<div class="mb-3">
	<a href="?{% if query %}q={{ query }}&{% endif %}{% if view_type %}view={{ view_type }}{% endif %}" class="btn btn-outline-primary btn-sm mb-2" style="background:#fff; color:#111; font-weight:bold; border-color:#fff;">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö</a>
	</div>
	{% endif %}
	{% if users %}
	<div class="grid">
		{% for user in users %}
		<div class="card" style="text-decoration: none; color: inherit; position: relative;">
			<div style="display: flex; align-items: center; gap: 8px;">
				<input type="checkbox" name="recipients" value="{{ user.id }}" class="user-checkbox" onclick="event.stopPropagation();">
				<div class="username">{{ user.username }}</div>
			</div>
			<div class="email{% if not user.email %} yellow-text{% endif %}">{{ user.email|default:'(–Ω–µ—Ç email)' }}</div>
			<div class="email" style="color:#1976d2; font-size:0.95em;">
				{% if user.locality %}
					üèôÔ∏è <a href="?{% if query %}q={{ query }}&{% endif %}{% if view_type %}view={{ view_type }}&{% endif %}locality_id={{ user.locality.id }}" style="color:#1976d2; text-decoration:underline;">{{ user.locality.name }}</a>
				{% else %}
					‚Äî
				{% endif %}
			</div>
			<div class="email{% if not user.plain_password %} yellow-text{% endif %}">
				{% if user.plain_password %}
					{{ user.plain_password }}
				{% else %}
					(–Ω–µ—Ç –ø–∞—Ä–æ–ª—è)
				{% endif %}
			</div>
			<div class="actions d-flex justify-content-center align-items-center" style="gap:4px; font-size:0.95em; flex-wrap: wrap; margin-top: 6px;">
				<a href="{% url 'edit_user' user.id %}" class="btn btn-outline-success btn-sm px-2 py-1" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" onclick="event.stopPropagation();" style="min-width:32px;">‚úèÔ∏è</a>
				<a href="{% url 'mass_mail' %}?user_id={{ user.id }}" class="btn btn-outline-warning btn-sm px-2 py-1" title="–ü–æ—á—Ç–∞" onclick="event.stopPropagation();" style="min-width:32px;">üìß</a>
				<a href="{% url 'delete_user' user.id %}" class="btn btn-outline-danger btn-sm px-2 py-1" title="–£–¥–∞–ª–∏—Ç—å" onclick="event.stopPropagation(); return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ user.username }}?');" style="min-width:32px;">üóëÔ∏è</a>
			</div>
		</div>
		{% endfor %}
	</div>
	{% else %}
	<div style="text-align:center; color:#888; font-size:1.2em; margin:40px 0;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
	{% endif %}
</form>
{% endif %}
<script>
// –ß–µ–∫–±–æ–∫—Å "–≤—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö"
const selectAll = document.getElementById('select-all');
const checkboxes = document.querySelectorAll('.user-checkbox');
selectAll.addEventListener('change', function() {
	checkboxes.forEach(cb => cb.checked = selectAll.checked);
});
checkboxes.forEach(cb => {
	cb.addEventListener('change', function() {
		if (!cb.checked) selectAll.checked = false;
		else if ([...checkboxes].every(c => c.checked)) selectAll.checked = true;
	});
});
// ...
</script>
{% endblock %}
